<link rel="stylesheet" href="/css/kanban.css">

<div class="home-wrapper">
  {{> sidebar}}
  {{> messages}}

  <div class="kanban-main">
    <!-- Header -->
    <header class="kanban-header">
      <div class="kanban-header-content">
        <div class="kanban-header-left">
          <h1 class="kanban-title">{{project.title}}</h1>
          <p class="kanban-subtitle">{{project.summary}}</p>
        </div>
        <a href="/ai-projects" class="kanban-new-btn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          New Project
        </a>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="kanban-stats">
      <div class="stat">
        <span class="stat-value">{{meta.stories_count}}</span>
        <span class="stat-label">Stories</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-value">{{meta.tasks_count}}</span>
        <span class="stat-label">Tasks</span>
      </div>
      <div class="stat-divider"></div>
      <div class="priority-legend">
        <span class="legend-label">Priority:</span>
        <span class="legend-item"><span class="priority-dot high"></span>High</span>
        <span class="legend-item"><span class="priority-dot medium"></span>Medium</span>
        <span class="legend-item"><span class="priority-dot low"></span>Low</span>
      </div>
    </div>

    <!-- Board -->
    <div class="kanban-board">
      <!-- Backlog Column -->
      <div class="kanban-column" data-status="backlog">
        <div class="column-header">
          <div class="column-indicator backlog"></div>
          <span class="column-title">Backlog</span>
          <span class="column-count">0</span>
        </div>
        <div class="column-content" id="backlog-stories">
          {{#each project.stories}}
          {{#if (eq status "backlog")}}
          <article class="story-card" data-story-id="{{id}}" data-priority="{{priority}}" draggable="true">
            <div class="story-content">
              <div class="story-header">
                <span class="story-priority-dot"></span>
                <h3 class="story-title">{{title}}</h3>
                <button class="story-toggle collapsed" aria-label="Toggle tasks" aria-expanded="false">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <p class="story-description">{{description}}</p>
              <div class="story-tasks collapsed">
                {{#each tasks}}
                <div class="task-item" data-task-id="{{id}}" data-status="{{status}}">
                  <div class="task-checkbox">
                    {{#if (eq status "done")}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M4.5 7L6 8.5L9.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{else if (eq status "in_progress")}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                      <circle cx="7" cy="7" r="2" fill="currentColor"/>
                    </svg>
                    {{else}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    {{/if}}
                  </div>
                  <span class="task-title">{{title}}</span>
                </div>
                {{/each}}
              </div>
            </div>
          </article>
          {{/if}}
          {{/each}}
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column" data-status="in_progress">
        <div class="column-header">
          <div class="column-indicator progress"></div>
          <span class="column-title">In Progress</span>
          <span class="column-count">0</span>
        </div>
        <div class="column-content" id="progress-stories">
          {{#each project.stories}}
          {{#if (eq status "in_progress")}}
          <article class="story-card" data-story-id="{{id}}" data-priority="{{priority}}" draggable="true">
            <div class="story-content">
              <div class="story-header">
                <span class="story-priority-dot"></span>
                <h3 class="story-title">{{title}}</h3>
                <button class="story-toggle collapsed" aria-label="Toggle tasks" aria-expanded="false">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <p class="story-description">{{description}}</p>
              <div class="story-tasks collapsed">
                {{#each tasks}}
                <div class="task-item" data-task-id="{{id}}" data-status="{{status}}">
                  <div class="task-checkbox">
                    {{#if (eq status "done")}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M4.5 7L6 8.5L9.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{else if (eq status "in_progress")}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                      <circle cx="7" cy="7" r="2" fill="currentColor"/>
                    </svg>
                    {{else}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    {{/if}}
                  </div>
                  <span class="task-title">{{title}}</span>
                </div>
                {{/each}}
              </div>
            </div>
          </article>
          {{/if}}
          {{/each}}
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column" data-status="done">
        <div class="column-header">
          <div class="column-indicator done"></div>
          <span class="column-title">Done</span>
          <span class="column-count">0</span>
        </div>
        <div class="column-content" id="done-stories">
          {{#each project.stories}}
          {{#if (eq status "done")}}
          <article class="story-card" data-story-id="{{id}}" data-priority="{{priority}}" draggable="true">
            <div class="story-content">
              <div class="story-header">
                <span class="story-priority-dot"></span>
                <h3 class="story-title">{{title}}</h3>
                <button class="story-toggle collapsed" aria-label="Toggle tasks" aria-expanded="false">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <p class="story-description">{{description}}</p>
              <div class="story-tasks collapsed">
                {{#each tasks}}
                <div class="task-item" data-task-id="{{id}}" data-status="{{status}}">
                  <div class="task-checkbox">
                    {{#if (eq status "done")}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M4.5 7L6 8.5L9.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{else if (eq status "in_progress")}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                      <circle cx="7" cy="7" r="2" fill="currentColor"/>
                    </svg>
                    {{else}}
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    {{/if}}
                  </div>
                  <span class="task-title">{{title}}</span>
                </div>
                {{/each}}
              </div>
            </div>
          </article>
          {{/if}}
          {{/each}}
        </div>
      </div>
    </div>

    <!-- Original Input -->
    <details class="original-input">
      <summary>Original Description</summary>
      <p>{{originalDescription}}</p>
    </details>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeDragAndDrop()
  initializeTaskToggle()
  initializeStoryToggle()
  updateColumnCounts()
})

function initializeStoryToggle() {
  const toggleButtons = document.querySelectorAll('.story-toggle')

  toggleButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation()
      e.preventDefault()

      const card = button.closest('.story-card')
      const tasks = card.querySelector('.story-tasks')
      const isCollapsed = tasks.classList.toggle('collapsed')

      button.classList.toggle('collapsed', isCollapsed)
      button.setAttribute('aria-expanded', !isCollapsed)
    })
  })
}

function initializeDragAndDrop() {
  const storyCards = document.querySelectorAll('.story-card')
  const columns = document.querySelectorAll('.column-content')

  storyCards.forEach(card => {
    card.addEventListener('dragstart', function(e) {
      if (e.target.closest('.story-toggle')) {
        e.preventDefault()
        return
      }
      e.dataTransfer.setData('text/plain', card.dataset.storyId)
      card.classList.add('dragging')

      requestAnimationFrame(() => {
        card.style.opacity = '0.5'
      })
    })

    card.addEventListener('dragend', function() {
      card.classList.remove('dragging')
      card.style.opacity = ''
    })
  })

  columns.forEach(column => {
    column.addEventListener('dragover', function(e) {
      e.preventDefault()
      column.classList.add('drag-over')
    })

    column.addEventListener('dragleave', function(e) {
      if (!column.contains(e.relatedTarget)) {
        column.classList.remove('drag-over')
      }
    })

    column.addEventListener('drop', function(e) {
      e.preventDefault()
      column.classList.remove('drag-over')

      const storyId = e.dataTransfer.getData('text/plain')
      const storyCard = document.querySelector(`[data-story-id="${storyId}"]`)
      const newStatus = column.parentElement.dataset.status

      if (storyCard && newStatus) {
        column.appendChild(storyCard)
        updateColumnCounts()
        console.log(`Story ${storyId} moved to ${newStatus}`)
      }
    })
  })
}

function initializeTaskToggle() {
  const taskItems = document.querySelectorAll('.task-item')

  taskItems.forEach(task => {
    task.addEventListener('click', function(e) {
      e.stopPropagation()

      const checkbox = task.querySelector('.task-checkbox')
      const currentStatus = task.dataset.status
      let newStatus

      if (currentStatus === 'todo') {
        newStatus = 'in_progress'
      } else if (currentStatus === 'in_progress') {
        newStatus = 'done'
      } else {
        newStatus = 'todo'
      }

      task.dataset.status = newStatus

      // Update SVG icon
      if (newStatus === 'done') {
        checkbox.innerHTML = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4.5 7L6 8.5L9.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`
      } else if (newStatus === 'in_progress') {
        checkbox.innerHTML = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="7" cy="7" r="2" fill="currentColor"/>
        </svg>`
      } else {
        checkbox.innerHTML = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
        </svg>`
      }

      console.log(`Task ${task.dataset.taskId} changed to ${newStatus}`)
    })
  })
}

function updateColumnCounts() {
  const columns = document.querySelectorAll('.kanban-column')

  columns.forEach(column => {
    const storyCount = column.querySelectorAll('.story-card').length
    const countElement = column.querySelector('.column-count')
    if (countElement) {
      countElement.textContent = storyCount
    }
  })
}
</script>
